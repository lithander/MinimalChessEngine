using System;

namespace MinimalChess
{
    public class Evaluation
    {
        public static int LostValue => -9999;

        private static int PieceTableIndex(Piece piece) => ((int)piece >> 2) - 1;

        //a black piece has 2nd bit set, white has not and square ^ 56 flips the file so it works for black
        private static int SquareTableIndex(int square, Piece piece) => square ^ (28 * ((int)piece & 2));

        public static int Evaluate(Board board)
        {
            int midGame = 0;
            int endGame = 0;
            int phase = 0;
            for (int i = 0; i < 64; i++)
            {
                Piece piece = board[i];
                if (piece == Piece.None)
                    continue;
                Color color = Pieces.GetColor(piece);
                int pieceIndex = PieceTableIndex(piece);
                int squareIndex = SquareTableIndex(i, piece);
                phase += PhaseValues[pieceIndex];
                midGame += (int)color * MidgameTables[pieceIndex, squareIndex];
                endGame += (int)color * EndgameTables[pieceIndex, squareIndex];
            }

            double factor = Linstep(Endgame, Midgame, phase);
            double score = factor * midGame + (1 - factor) * endGame;
            return (int)score;
        }

        public static double Linstep(double edge0, double edge1, double v)
        {
            return Math.Min(1, Math.Max(0, (v - edge0) / (edge1 - edge0)));
        }
        /* Tabasco [Gold 008]
        492662| +0.379991
         55647| +0.285247
         42024| +0.230607
         58090| +0.292530
         52509| +0.297351
         36673| +0.227421
         61334| +0.236479
         75557| +0.198525
         56034| +0.180318
        497470| +0.163569 
        ----------------- 
                +0.262393 
        */
        static readonly int Midgame = 4517;
        static readonly int Endgame = 1190;

        static readonly int[] PhaseValues = new int[6] { 0, 205, 300, 500, 956, 0 };

        static readonly int[,] MidgameTables = new int[6, 64]{
        {  //PAWN
           100,   100,   100,   100,   100,   100,   100,   100,
           118,   119,   108,   129,   147,   135,   121,    89,
            69,    86,   101,    93,   105,   136,    91,    77,
            71,    83,    77,    84,    94,    83,    85,    63,
            52,    77,    71,    87,    86,    78,    82,    50,
            57,    75,    77,    73,    87,    70,   108,    77,
            56,    84,    68,    64,    76,   101,   121,    78,
           100,   100,   100,   100,   100,   100,   100,   100,
        },
        {  //KNIGHT MG
           117,   288,   278,   278,   301,   215,   300,   196,
           248,   283,   365,   323,   363,   357,   305,   295,
           302,   325,   334,   361,   380,   392,   356,   304,
           318,   325,   325,   359,   332,   352,   316,   330,
           301,   312,   327,   325,   335,   335,   318,   294,
           295,   308,   326,   325,   332,   322,   328,   291,
           287,   283,   308,   314,   314,   324,   305,   307,
           263,   292,   268,   288,   286,   302,   288,   249,
        },
        {  //BISHOP MG
           297,   301,   303,   294,   273,   291,   310,   262,
           315,   347,   329,   326,   348,   381,   344,   349,
           330,   341,   376,   360,   384,   375,   368,   366,
           321,   340,   357,   366,   366,   345,   348,   333,
           329,   350,   351,   367,   370,   353,   347,   318,
           356,   357,   357,   353,   357,   358,   349,   354,
           327,   362,   347,   345,   347,   364,   371,   344,
           343,   323,   337,   331,   323,   325,   331,   332,
        },
        {  //ROOK MG
           500,   502,   503,   504,   517,   516,   504,   497,
           487,   480,   500,   519,   499,   524,   526,   510,
           482,   489,   488,   504,   514,   522,   511,   512,
           460,   472,   493,   499,   488,   492,   509,   508,
           458,   460,   460,   473,   475,   472,   491,   474,
           452,   464,   474,   480,   477,   470,   494,   483,
           446,   467,   464,   469,   470,   476,   494,   441,
           467,   471,   482,   485,   485,   474,   458,   465,
        },
        {  //QUEEN MG
           851,   895,   908,   915,   916,   918,   897,   863,
           878,   875,   885,   883,   887,   969,   927,   965,
           880,   891,   911,   925,   942,   955,   968,   940,
           878,   892,   898,   901,   909,   916,   902,   915,
           885,   900,   894,   902,   909,   906,   913,   895,
           884,   901,   904,   902,   904,   910,   912,   896,
           885,   904,   904,   905,   908,   913,   913,   902,
           904,   884,   892,   905,   891,   880,   867,   887,
        },
        {  //KING MG
             0,     0,     0,     0,     0,     0,     0,     0,
             0,     6,     2,     4,     1,    11,    -1,     0,
             0,    14,     1,     4,     0,     0,     0,    -1,
            -1,     0,     3,     1,    -1,    -4,    -3,    -8,
             1,     1,     2,   -16,   -14,   -26,   -14,   -33,
             0,     5,   -62,   -65,   -67,   -33,    -1,   -14,
            16,     1,   -15,   -54,   -42,    -8,    27,    20,
           -25,    27,     7,   -43,     1,   -25,    30,    22,
        }
        };

        static int[,] EndgameTables = new int[6, 64]{
        {  //PAWN EG
           100,   100,   100,   100,   100,   100,   100,   100,
           245,   243,   228,   203,   195,   208,   236,   229,
           175,   175,   165,   149,   138,   133,   157,   159,
           118,   111,   101,    95,    88,    91,   102,   100,
            96,    96,    84,    83,    82,    81,    88,    83,
            91,    94,    84,    92,    88,    87,    90,    81,
            98,    99,    96,    97,    91,    94,    92,    82,
           100,   100,   100,   100,   100,   100,   100,   100,
        },
        {  //KNIGHT EG
           230,   218,   243,   243,   244,   233,   231,   183,
           236,   252,   253,   262,   249,   250,   241,   226,
           244,   255,   280,   282,   266,   273,   255,   248,
           255,   276,   282,   289,   287,   284,   274,   254,
           256,   268,   286,   288,   289,   274,   261,   256,
           245,   268,   268,   282,   280,   271,   260,   242,
           248,   251,   255,   266,   266,   261,   253,   242,
           226,   240,   251,   261,   252,   256,   243,   239,
        },
        {  //BISHOP EG
           275,   262,   267,   279,   273,   277,   268,   277,
           269,   283,   287,   276,   286,   276,   280,   256,
           284,   289,   289,   296,   286,   296,   287,   277,
           288,   295,   294,   298,   299,   288,   285,   276,
           276,   286,   298,   294,   294,   296,   280,   275,
           272,   285,   292,   295,   300,   289,   275,   269,
           275,   275,   276,   289,   290,   280,   279,   269,
           260,   272,   265,   280,   278,   279,   264,   265,
        },
        {  //ROOK EG
           491,   487,   489,   486,   483,   479,   478,   480,
           483,   490,   490,   485,   480,   482,   480,   474,
           480,   480,   480,   478,   475,   474,   477,   472,
           476,   476,   480,   477,   474,   475,   471,   468,
           473,   474,   478,   479,   476,   472,   465,   460,
           465,   470,   471,   471,   472,   465,   459,   458,
           470,   470,   476,   475,   472,   471,   467,   465,
           470,   477,   480,   485,   476,   467,   470,   454,
        },
        {  //QUEEN EG
           907,   904,   908,   922,   921,   917,   897,   919,
           898,   901,   916,   933,   930,   942,   909,   877,
           881,   898,   915,   912,   936,   914,   900,   893,
           890,   904,   908,   927,   938,   932,   911,   900,
           897,   902,   911,   922,   926,   908,   904,   896,
           886,   893,   906,   901,   908,   899,   904,   893,
           900,   900,   898,   904,   899,   882,   880,   885,
           890,   896,   901,   882,   902,   888,   891,   885,
        },
        {  //KING EG
           -45,   -15,   -20,   -15,   -11,    -1,    -4,   -27,
           -15,     5,     0,    -2,     2,    18,    17,     2,
           -15,    11,     8,     8,    10,    22,    28,     8,
           -24,    -2,     8,    12,    11,    18,    15,     0,
           -32,    -6,     7,    13,    16,    16,     6,   -10,
           -29,    -6,     7,    15,    16,    14,     5,   -10,
           -27,   -10,     3,    10,    10,     8,    -1,   -16,
           -36,   -27,   -17,   -18,   -22,   -15,   -27,   -49,
        }};
    }
}
